kind: pipeline
name: default

# TODO, move most of this to a drone plugin
# Env vars:
#   - DRONE_YOE_REPO (can we get this from drone env??)
#   - DRONE_YOE_REPO_BRANCH (can we get this from drone env??)
#   - DRONE_YOE_DOCKER_IMAGE
#   - DRONE_YOE_CACHE_DIR
#   - DRONE_YOE_IMAGE
#   - DRONE_YOE_ENVSETUP

clone:
  disable: true

steps:
  - name: build
    image: yoedistro/yoe-build:stretch
    volumes:
      - name: drone-cache
        path: /scratch/drone-cache
    environment:
      YOE_SKIP_SHELL_TEST: true
      DOCKER_REPO: none
    commands:
      - cd /scratch/drone-cache
      - pwd
      - echo "building $${DRONE_REPO}, branch $${DRONE_REPO_BRANCH}"
      - export CACHE_DIR="$${DRONE_REPO_NAMESPACE}-$${DRONE_REPO_NAME}-$${DRONE_REPO_BRANCH}"
      - "[ -e yoe-distro ] || git clone $${DRONE_GIT_HTTP_URL} $${CACHE_DIR}"
      - cd ${CACHE_DIR}
      - git checkout $${DRONE_REPO_BRANCH}
      - git pull
      - git submodule update --recursive --init
      - /bin/sh -c "source ./raspberrypi3-64-envsetup.sh; bitbake yoe-simple-image"

volumes:
  - name: drone-cache
    host:
      path: /scratch/drone-cache

node:
  oe: true
